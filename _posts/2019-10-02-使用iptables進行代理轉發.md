---
title: "使用iptables對TCP代理轉發"
date: 2019-10-02
categories:
  - blog
tags:
  - 代理轉發
  - 代理
---
- ## TCP
1. ### 代理轉發設置
```sh
iptables -t nat -N SS_SPEC_WAN_FW
iptables -t nat -A SS_SPEC_WAN_FW -d <server_1_ip> -p tcp -j REDIRECT --to-ports <server_2_port> 
#如果有多個服務器可以繼續串連比如：
#iptables -t nat -A SS_SPEC_WAN_FW -d <server_2_ip> -p tcp -j REDIRECT --to-ports <server_3_port> 
#iptables -t nat -A SS_SPEC_WAN_FW -d <server_3_ip> -p tcp -j REDIRECT --to-ports <server_4_port>
iptables -t nat -A SS_SPEC_WAN_FW -d <server_out_ip> -j RETURN #此<server_out_ip>為最外層代理的ip 不進行代理
iptables -t nat -A SS_SPEC_WAN_FW -p tcp -j REDIRECT --to-ports <server_1_port> #對其餘流量轉發到最內層代理
```
2. ### 流量入口設置 
```sh
iptables -t nat -N SS_SPEC_WAN_AC
iptables -t nat -A SS_SPEC_WAN_AC -p tcp -j RETURN -m mark --mark 0xff
iptables -t nat -A SS_SPEC_WAN_AC -d 0.0.0.0/8 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 10.0.0.0/8 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 100.64.0.0/10 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 127.0.0.0/8 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 169.254.0.0/16 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 172.16.0.0/12 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 192.0.0.0/24 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 192.0.2.0/24 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 192.88.99.0/24 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 192.168.0.0/16 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 198.18.0.0/15 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 198.51.100.0/24 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 203.0.113.0/24 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 224.0.0.0/4 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 240.0.0.0/4 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -d 255.255.255.255 -j RETURN
iptables -t nat -A SS_SPEC_WAN_AC -j SS_SPEC_WAN_FW
iptables -t nat -I PREROUTING 1 -i <需要代理網卡名> -p tcp  -j SS_SPEC_WAN_AC
iptables -t nat -I OUTPUT 1 -p tcp  -j SS_SPEC_WAN_AC #對本機代理
```